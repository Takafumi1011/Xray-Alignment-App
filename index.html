<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bilateral X-ray Alignment Tool</title>
    <style>
        body { margin: 0; font-family: sans-serif; background: #000; color: #fff; overflow: hidden; touch-action: none; }
        #header { position: absolute; top: 0; width: 100%; background: rgba(0,0,0,0.9); z-index: 100; font-size: 11px; border-bottom: 1px solid #444; }
        .row { display: flex; justify-content: space-around; padding: 6px 0; border-bottom: 1px solid #222; }
        .val { color: #007AFF; font-weight: bold; font-size: 13px; }
        #canvas-container { position: relative; width: 100vw; height: 100vh; }
        canvas { display: block; }
        .controls { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; gap: 10px; }
        button { padding: 12px 18px; border-radius: 10px; border: none; background: #007AFF; color: #fff; font-weight: bold; font-size: 14px; }
        .auto-btn { background: #34C759; }
    </style>
</head>
<body>

<div id="header">
    <div class="row">
        <div>【右】 mHKA: <span id="r-hka" class="val">-</span>°</div>
        <div>LDFA: <span id="r-ldfa" class="val">-</span>°</div>
        <div>MPTA: <span id="r-mpta" class="val">-</span>°</div>
        <div>JLCA: <span id="r-jlca" class="val">-</span>°</div>
        <div>JLOA: <span id="r-jloa" class="val">-</span>°</div>
    </div>
    <div class="row">
        <div>【左】 mHKA: <span id="l-hka" class="val">-</span>°</div>
        <div>LDFA: <span id="l-ldfa" class="val">-</span>°</div>
        <div>MPTA: <span id="l-mpta" class="val">-</span>°</div>
        <div>JLCA: <span id="l-jlca" class="val">-</span>°</div>
        <div>JLOA: <span id="l-jloa" class="val">-</span>°</div>
    </div>
</div>

<div id="canvas-container">
    <canvas id="mainCanvas"></canvas>
</div>

<div class="controls">
    <input type="file" id="upload" accept="image/*" style="display:none">
    <button onclick="document.getElementById('upload').click()">画像選択</button>
    <button class="auto-btn" onclick="autoDetect()">自動検索</button>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const upload = document.getElementById('upload');
    let img = new Image();
    let imgScale = 1;
    let activePoint = null;

    // 左右16点の初期配置
    let points = [];
    function initPoints() {
        const w = window.innerWidth; const h = window.innerHeight;
        const rX = w * 0.35, lX = w * 0.65;
        points = [
            // 右脚
            { x: rX, y: h*0.2, label: 'RH' }, { x: rX, y: h*0.45, label: 'RKf' },
            { x: rX, y: h*0.5, label: 'RKt' }, { x: rX, y: h*0.8, label: 'RA' },
            { x: rX-30, y: h*0.46, label: 'RMF' }, { x: rX+30, y: h*0.46, label: 'RLF' },
            { x: rX-30, y: h*0.49, label: 'RMT' }, { x: rX+30, y: h*0.49, label: 'RLT' },
            // 左脚
            { x: lX, y: h*0.2, label: 'LH' }, { x: lX, y: h*0.45, label: 'LKf' },
            { x: lX, y: h*0.5, label: 'LKt' }, { x: lX, y: h*0.8, label: 'LA' },
            { x: lX-30, y: h*0.46, label: 'LMF' }, { x: lX+30, y: h*0.46, label: 'LLF' },
            { x: lX-30, y: h*0.49, label: 'LMT' }, { x: lX+30, y: h*0.49, label: 'LLT' }
        ];
    }

    upload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (f) => { img.onload = () => { resizeCanvas(); draw(); }; img.src = f.target.result; };
        reader.readAsDataURL(file);
    });

    function resizeCanvas() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        if (points.length === 0) initPoints();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (img.src) {
            imgScale = Math.min(canvas.width / img.width, canvas.height / img.height);
            ctx.drawImage(img, 0, 0, img.width * imgScale, img.height * imgScale);
        }
        
        // 線描画 (R=0-7, L=8-15)
        [[0,8],[1,9]].forEach(s => {
            const o = s[0] === 0 ? 0 : 8;
            const side = s[0] === 0 ? 'r' : 'l';
            ctx.lineWidth = 1;
            drawLine(points[o+0], points[o+1], '#FF3B30'); // Femur
            drawLine(points[o+2], points[o+3], '#5856D6'); // Tibia
            drawLine(points[o+4], points[o+5], '#FFCC00'); // F-Joint
            drawLine(points[o+6], points[o+7], '#34C759'); // T-Joint
        });

        points.forEach(p => {
            ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2);
            ctx.fillStyle = (p === activePoint) ? '#00FF00' : '#FF3B30';
            ctx.fill();
            ctx.fillStyle = "white"; ctx.font = "9px sans-serif";
            ctx.fillText(p.label, p.x + 7, p.y + 7);
        });

        if (activePoint) drawLoupe();
        calculateAll();
    }

    function drawLine(p1, p2, color) {
        ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
        ctx.strokeStyle = color; ctx.stroke();
    }

    function calculateAll() {
        const calc = (o, prefix) => {
            const getA = (a, b) => Math.atan2(b.y - a.y, b.x - a.x) * 180 / Math.PI;
            const fA = getA(points[o+0], points[o+1]); // Femur Axis
            const tA = getA(points[o+2], points[o+3]); // Tibia Axis
            const fJ = getA(points[o+4], points[o+5]); // Femur Joint
            const tJ = getA(points[o+6], points[o+7]); // Tibia Joint

            // 1. mHKA (0基準, 内反-, 外反+)
            let hka = (prefix === 'r') ? (tA - fA) : (fA - tA);
            document.getElementById(prefix+'-hka').innerText = hka.toFixed(1);

            // 2. LDFA (90基準, 内反>90, 外反<90)
            let ldfa = 90 + (fA - fJ);
            document.getElementById(prefix+'-ldfa').innerText = ldfa.toFixed(1);

            // 3. MPTA (90基準, 内反<90, 外反>90)
            let mpta = 90 - (tA - tJ);
            document.getElementById(prefix+'-mpta').innerText = mpta.toFixed(1);

            // 4. JLCA (0基準, 外側オープン-, 内側オープン+)
            let jlca = (prefix === 'r') ? (fJ - tJ) : (tJ - fJ);
            document.getElementById(prefix+'-jlca').innerText = jlca.toFixed(1);

            // 5. JLOA (水平0基準)
            document.getElementById(prefix+'-jloa').innerText = Math.abs(fJ).toFixed(1);
        };
        calc(0, 'r'); calc(8, 'l');
    }

    function drawLoupe() {
        const size = 160; const lx = (window.innerWidth - size)/2; const ly = 120;
        ctx.save(); ctx.beginPath(); ctx.rect(lx, ly, size, size); ctx.clip();
        ctx.fillStyle = "#000"; ctx.fillRect(lx, ly, size, size);
        if (img.src) {
            const zoom = 2.5; const sw = size/zoom; const sh = size/zoom;
            ctx.drawImage(img, (activePoint.x - sw/2)/imgScale, (activePoint.y - sh/2)/imgScale, sw/imgScale, sh/imgScale, lx, ly, size, size);
        }
        ctx.strokeStyle = "#00FF00"; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(lx+size/2, ly); ctx.lineTo(lx+size/2, ly+size);
        ctx.moveTo(lx, ly+size/2); ctx.lineTo(lx+size, ly+size/2); ctx.stroke();
        ctx.restore();
        ctx.strokeStyle = "white"; ctx.lineWidth = 2; ctx.strokeRect(lx, ly, size, size);
    }

    // 簡易自動検出（輝度スキャン）
    function autoDetect() {
        if (!img.src) return;
        const tempCanvas = document.createElement('canvas');
        const tCtx = tempCanvas.getContext('2d');
        tempCanvas.width = 100; tempCanvas.height = 100; // 縮小して高速スキャン
        tCtx.drawImage(img, 0, 0, 100, 100);
        const data = tCtx.getImageData(0, 0, 100, 100).data;
        
        // 骨の白さを検知して各ポイントを微調整（デモ版：垂直方向の重心へ）
        points.forEach(p => {
            const ix = Math.round(p.x / window.innerWidth * 100);
            const iy = Math.round(p.y / window.innerHeight * 100);
            let bestY = iy; let maxB = 0;
            for(let dy=-5; dy<=5; dy++) {
                const idx = ((iy+dy)*100 + ix) * 4;
                const b = data[idx] + data[idx+1] + data[idx+2];
                if(b > maxB) { maxB = b; bestY = iy+dy; }
            }
            p.y = (bestY / 100) * window.innerHeight;
        });
        draw();
    }

    canvas.addEventListener('touchstart', e => {
        e.preventDefault(); const t = e.touches[0];
        activePoint = points.find(p => Math.hypot(p.x - t.clientX, p.y - t.clientY) < 35);
        if(activePoint) draw();
    }, {passive: false});

    canvas.addEventListener('touchmove', e => {
        e.preventDefault(); if (!activePoint) return;
        const t = e.touches[0]; activePoint.x = t.clientX; activePoint.y = t.clientY;
        draw();
    }, {passive: false});

    canvas.addEventListener('touchend', () => { activePoint = null; draw(); });
    window.onload = resizeCanvas;
</script>
</body>
</html>
